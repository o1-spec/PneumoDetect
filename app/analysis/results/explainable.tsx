import React, { useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Image,
  Switch,
} from "react-native";
import { router, useLocalSearchParams } from "expo-router";
import { Ionicons } from "@expo/vector-icons";
import Slider from "@react-native-community/slider";

export default function ExplainableAIScreen() {
  const { scanId, imageUri, prediction, confidence } = useLocalSearchParams();
  const [showHeatmap, setShowHeatmap] = useState(true);
  const [opacity, setOpacity] = useState(0.6);

  // Simulated heatmap overlay (in production, this would be generated by the model)
  const heatmapUri = "https://via.placeholder.com/400x400/FF0000/FFFFFF?text=Heatmap";

  return (
    <View style={styles.container}>
      {/* Header */}
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => router.back()}
        >
          <Ionicons name="arrow-back" size={24} color="#0066CC" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Explainable AI</Text>
        <View style={styles.placeholder} />
      </View>

      <ScrollView
        style={styles.content}
        showsVerticalScrollIndicator={false}
      >
        {/* Info Card */}
        <View style={styles.infoCard}>
          <Ionicons name="bulb" size={24} color="#0066CC" />
          <View style={styles.infoTextContainer}>
            <Text style={styles.infoTitle}>Grad-CAM Visualization</Text>
            <Text style={styles.infoText}>
              The heatmap highlights areas the AI focused on when making its
              diagnosis. Red/warm areas indicate higher importance.
            </Text>
          </View>
        </View>

        {/* Image Viewer */}
        <View style={styles.imageContainer}>
          {/* Original X-Ray */}
          <Image
            source={{ uri: imageUri as string }}
            style={styles.baseImage}
          />

          {/* Heatmap Overlay */}
          {showHeatmap && (
            <Image
              source={{ uri: heatmapUri }}
              style={[styles.heatmapOverlay, { opacity }]}
            />
          )}
        </View>

        {/* Controls */}
        <View style={styles.controlsCard}>
          <Text style={styles.controlsTitle}>Visualization Controls</Text>

          {/* Toggle Heatmap */}
          <View style={styles.controlRow}>
            <View style={styles.controlLabel}>
              <Ionicons name="eye-outline" size={20} color="#636366" />
              <Text style={styles.controlLabelText}>Show Heatmap</Text>
            </View>
            <Switch
              value={showHeatmap}
              onValueChange={setShowHeatmap}
              trackColor={{ false: "#E5E5EA", true: "#0066CC" }}
              thumbColor="#FFFFFF"
            />
          </View>

          {/* Opacity Slider */}
          {showHeatmap && (
            <View style={styles.sliderContainer}>
              <View style={styles.sliderHeader}>
                <Text style={styles.sliderLabel}>Heatmap Opacity</Text>
                <Text style={styles.sliderValue}>{Math.round(opacity * 100)}%</Text>
              </View>
              <Slider
                style={styles.slider}
                minimumValue={0}
                maximumValue={1}
                value={opacity}
                onValueChange={setOpacity}
                minimumTrackTintColor="#0066CC"
                maximumTrackTintColor="#E5E5EA"
                thumbTintColor="#0066CC"
              />
            </View>
          )}
        </View>

        {/* Prediction Summary */}
        <View style={styles.summaryCard}>
          <Text style={styles.summaryTitle}>AI Analysis Summary</Text>
          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>Prediction:</Text>
            <Text
              style={[
                styles.summaryValue,
                prediction === "Pneumonia Detected"
                  ? styles.textDanger
                  : styles.textSafe,
              ]}
            >
              {prediction}
            </Text>
          </View>
          <View style={styles.summaryRow}>
            <Text style={styles.summaryLabel}>Confidence:</Text>
            <Text style={styles.summaryValue}>{confidence}%</Text>
          </View>
        </View>

        {/* Explanation */}
        <View style={styles.explanationCard}>
          <Text style={styles.explanationTitle}>ðŸ“‹ Interpretation Guide</Text>
          <View style={styles.explanationItem}>
            <View style={[styles.colorDot, { backgroundColor: "#FF0000" }]} />
            <Text style={styles.explanationText}>
              <Text style={styles.bold}>Hot (Red):</Text> High activation -
              areas most influential to the diagnosis
            </Text>
          </View>
          <View style={styles.explanationItem}>
            <View style={[styles.colorDot, { backgroundColor: "#FFFF00" }]} />
            <Text style={styles.explanationText}>
              <Text style={styles.bold}>Warm (Yellow):</Text> Moderate
              activation - supportive regions
            </Text>
          </View>
          <View style={styles.explanationItem}>
            <View style={[styles.colorDot, { backgroundColor: "#0000FF" }]} />
            <Text style={styles.explanationText}>
              <Text style={styles.bold}>Cool (Blue):</Text> Low activation -
              less relevant areas
            </Text>
          </View>
        </View>

        {/* Clinical Note */}
        {prediction === "Pneumonia Detected" && (
          <View style={styles.clinicalNote}>
            <Ionicons name="medical" size={20} color="#D32F2F" />
            <Text style={styles.clinicalNoteText}>
              The model detected abnormal patterns consistent with pneumonia,
              particularly in the highlighted regions. Recommend clinical
              correlation and follow-up.
            </Text>
          </View>
        )}

        <View style={styles.bottomSpacer} />
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#F5F5F7",
  },
  header: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    paddingHorizontal: 16,
    paddingTop: 60,
    paddingBottom: 16,
    backgroundColor: "#FFFFFF",
    borderBottomWidth: 1,
    borderBottomColor: "#E5E5EA",
  },
  backButton: {
    padding: 8,
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: "bold",
    color: "#1C1C1E",
  },
  placeholder: {
    width: 40,
  },
  content: {
    flex: 1,
    padding: 16,
  },
  infoCard: {
    flexDirection: "row",
    backgroundColor: "#E3F2FD",
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    gap: 12,
  },
  infoTextContainer: {
    flex: 1,
  },
  infoTitle: {
    fontSize: 16,
    fontWeight: "bold",
    color: "#0066CC",
    marginBottom: 4,
  },
  infoText: {
    fontSize: 14,
    color: "#0066CC",
    lineHeight: 20,
  },
  imageContainer: {
    backgroundColor: "#000000",
    borderRadius: 12,
    overflow: "hidden",
    marginBottom: 16,
    position: "relative",
  },
  baseImage: {
    width: "100%",
    height: 400,
  },
  heatmapOverlay: {
    position: "absolute",
    top: 0,
    left: 0,
    width: "100%",
    height: "100%",
  },
  controlsCard: {
    backgroundColor: "#FFFFFF",
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  controlsTitle: {
    fontSize: 16,
    fontWeight: "bold",
    color: "#1C1C1E",
    marginBottom: 16,
  },
  controlRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: "#F5F5F7",
  },
  controlLabel: {
    flexDirection: "row",
    alignItems: "center",
    gap: 8,
  },
  controlLabelText: {
    fontSize: 16,
    color: "#1C1C1E",
  },
  sliderContainer: {
    paddingTop: 16,
  },
  sliderHeader: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 8,
  },
  sliderLabel: {
    fontSize: 14,
    color: "#636366",
  },
  sliderValue: {
    fontSize: 14,
    fontWeight: "bold",
    color: "#0066CC",
  },
  slider: {
    width: "100%",
    height: 40,
  },
  summaryCard: {
    backgroundColor: "#FFFFFF",
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  summaryTitle: {
    fontSize: 16,
    fontWeight: "bold",
    color: "#1C1C1E",
    marginBottom: 12,
  },
  summaryRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    paddingVertical: 8,
  },
  summaryLabel: {
    fontSize: 14,
    color: "#636366",
  },
  summaryValue: {
    fontSize: 14,
    fontWeight: "bold",
    color: "#1C1C1E",
  },
  textDanger: {
    color: "#D32F2F",
  },
  textSafe: {
    color: "#4CAF50",
  },
  explanationCard: {
    backgroundColor: "#FFFFFF",
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },
  explanationTitle: {
    fontSize: 16,
    fontWeight: "bold",
    color: "#1C1C1E",
    marginBottom: 16,
  },
  explanationItem: {
    flexDirection: "row",
    alignItems: "center",
    gap: 12,
    marginBottom: 12,
  },
  colorDot: {
    width: 20,
    height: 20,
    borderRadius: 10,
    borderWidth: 1,
    borderColor: "#E5E5EA",
  },
  explanationText: {
    flex: 1,
    fontSize: 14,
    color: "#1C1C1E",
    lineHeight: 20,
  },
  bold: {
    fontWeight: "bold",
  },
  clinicalNote: {
    flexDirection: "row",
    backgroundColor: "#FFEBEE",
    borderRadius: 12,
    padding: 16,
    gap: 12,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: "#FFCDD2",
  },
  clinicalNoteText: {
    flex: 1,
    fontSize: 14,
    color: "#D32F2F",
    lineHeight: 20,
  },
  bottomSpacer: {
    height: 40,
  },
});